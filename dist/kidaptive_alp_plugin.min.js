(function(){"use strict";var t=new springroll.ApplicationPlugin;t.preload=function(t){var i=function(t,i){return t instanceof Function&&t.bind(this)(i)||t}.bind(this);var e={options:{}};var n=function(t){Object.keys(t).forEach(function(i){if(i==="options"){Object.keys(t[i]).forEach(function(n){e.options[n]=t[i][n]})}else{e[i]=t[i]}})};if(this.config.alp){n(this.config.alp)}if(this.options.alp){n(this.options.alp)}var o=e.recType;var a=e.recParams;var s=e.recCallback;var r=e.gameUri;var c=e.eventOverride;var u=this.learning.catalog.events||{};var d=KidaptiveSdk.KidaptiveUtils.copyObject(e.options)||{};d.autoFlushCallbacks=d.autoFlushCallbacks||[];d.autoFlushCallbacks.splice(0,0,function(t){t.then(function(){if(!KidaptiveSdk.getCurrentUser()&&!KidaptiveSdk.isAnonymousSession()){KidaptiveSdk.startAnonymousSession()}})});KidaptiveSdk.init(e.apiKey,e.version,d).then(function(t){var n={};this.alpPlugin={sdk:t,getRecommendation:function(e){var n=t.KidaptiveUtils.copyObject(i(o,e)||"optimalDifficulty");var c=t.KidaptiveUtils.copyObject(i(a,e))||{};c.learnerId=t.getLearnerList()[0].id;c.game=r;var u;switch(n){case"random":u=t.getRandomRecommendations(c);break;case"optimalDifficulty":u=t.getOptimalDifficultyRecommendations(c);break;default:u=t.getRecommendations(n,c)}return s?s.bind(this)(u,e):u}.bind(this),getState:function(){return t.KidaptiveUtils.copyObject(n)},setState:function(i){Object.keys(i).forEach(function(t){if(i[t]===undefined){delete n[t]}});i=t.KidaptiveUtils.copyObject(i);Object.keys(i).forEach(function(t){n[t]=i[t]})},getInitParams:function(){return KidaptiveSdk.KidaptiveUtils.copyObject(e,true)}};if(!e.options.noOidc&&this.container){var d=function(i){if(t.KidaptiveUtils.getObject(i,["data","name"])!=="Kidaptive ALP"){return}var e;t.init().then(function(){e=t.KidaptiveUtils.getObject(t.getCurrentUser(),"id");if(t.isAnonymousSession()){t.logoutUser()}return t.refresh()}).then(function(){var i=t.KidaptiveUtils.getObject(t.getCurrentUser(),"id");if(!i){throw new Error}if(i!==e){n={}}}).catch(function(){t.logoutUser();t.startAnonymousSession().then(function(){n={}})})};var l=function(i){if(t.KidaptiveUtils.getObject(i,["data","name"])!=="Kidaptive ALP"){return}t.init().then(function(){if(!t.isAnonymousSession()){t.logoutUser();t.startAnonymousSession().then(function(){n={}})}})};var f=function(){t.init().then(function(){if(t.isAnonymousSession()){t.logoutUser()}t.logoutUser();t.startAnonymousSession().then(function(){n={}})})};this.container.on("openIdAuthSuccess",d);this.container.on("openIdRefreshAuthSuccess",d);this.container.on("openIdAuthFailure",l);this.container.on("openIdRefreshAuthFailure",l);this.container.on("openIdAllLogoutsComplete",f)}if(this.learning){var p=function(i){if(!t.getCurrentUser()){return}var e=u[i.event_data.event_code]||"Springroll Event";var n=t.KidaptiveUtils.copyObject(i.event_data);var o={additionalFields:n};o.gameUri=r;o.learnerId=t.getLearnerList()[0].id;for(var a in n){if(a==="duration"&&typeof n[a]==="number"){o[a]=n[a]/1e3;delete n[a]}else if(n[a]instanceof Object){n[a]=t.KidaptiveUtils.toJson(n[a])}else{n[a]=n[a].toString()}}n.springroll_game_id=i.game_id;n.springroll_event_id=i.event_id;n.springroll_event_code=n.event_code;delete n.event_code;t.reportBehavior(e,o)};var v=(c||p).bind(this);this.learning.on("learningEvent",function(t){v(t,p)}.bind(this))}if(!t.getCurrentUser()){return t.startAnonymousSession()}}.bind(this)).then(function(){t()})};t.teardown=function(){this.alpPlugin.sdk.destroy().then(function(){delete this.alpPlugin}.bind(this))}})();
